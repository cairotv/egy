<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CINEMA ONLINE | مشاهدة فورية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = { theme: { extend: { colors: { brand: '#E50914', dark: '#141414' }, fontFamily: { sans: ['Cairo', 'sans-serif'] } } } }
    </script>
    <style>
        body { background-color: #141414; color: white; overflow-x: hidden; }
        /* تصميم شاشة التحميل البسيطة */
        #loader { position: fixed; inset: 0; background: #141414; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #E50914; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* إخفاء السكرول */
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-500 text-sm">لحظة واحدة...</p>
        </div>
    </div>

    <div id="main-content" style="opacity: 0; transition: opacity 1s;">
        
        <nav class="fixed w-full z-50 bg-black/90 backdrop-blur border-b border-white/10">
            <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                    <i class="fas fa-play-circle text-3xl text-brand"></i>
                    <h1 class="text-xl font-black">CINEMA<span class="text-gray-400 text-xs tracking-widest">ONLINE</span></h1>
                </div>
                <div class="hidden md:flex gap-6 font-bold text-sm text-gray-300">
                    <button onclick="renderGrid(allData)" class="hover:text-brand">الكل</button>
                    <button onclick="filterType('movie')" class="hover:text-brand">أفلام</button>
                    <button onclick="filterType('series')" class="hover:text-brand">مسلسلات</button>
                </div>
            </div>
        </nav>

        <main class="pt-20 px-4 container mx-auto min-h-screen">
            <div id="empty-msg" class="hidden text-center mt-20">
                <i class="fas fa-film text-6xl text-gray-800 mb-4"></i>
                <p class="text-gray-500">لا توجد أفلام حالياً. شغل البوت من GitHub.</p>
            </div>

            <div id="grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                </div>
        </main>

        <div id="modal" class="fixed inset-0 z-[60] bg-black/95 hidden overflow-y-auto">
            <button onclick="closeModal()" class="fixed top-4 left-4 z-[70] bg-gray-800 w-10 h-10 rounded-full text-white hover:bg-brand"><i class="fas fa-times"></i></button>
            <div id="modal-content" class="min-h-screen"></div>
        </div>
    </div>

    <script>
        // إعدادات الاتصال المباشر (بدون Vue)
        const SUPABASE_URL = 'https://wzeqtnkzytmlmeujaxnl.supabase.co';
        const SUPABASE_KEY = 'EyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6ZXF0bmt6eXRtbG1ldWpheG5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjMwNDEsImV4cCI6MjA4NjQzOTA0MX0.xwu-ZpaX77nxGHH4HlRjQ0Cxy0KrbdT6xBRAvZw70uU';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let allData = [];

        // 1. التشغيل الفوري
        async function init() {
            // كسر شاشة التحميل بعد 3 ثواني كحد أقصى (نظام أمان)
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => { 
                    document.getElementById('loader').style.display = 'none'; 
                    document.getElementById('main-content').style.opacity = '1';
                }, 500);
            }, 2000);

            try {
                // جلب البيانات
                const { data: m } = await supabase.from('movies').select('*').limit(40).order('added_at', {ascending: false});
                const { data: s } = await supabase.from('series').select('*').limit(40).order('added_at', {ascending: false});
                
                allData = [
                    ...(m || []).map(x => ({...x, type: 'movie'})), 
                    ...(s || []).map(x => ({...x, type: 'series'}))
                ].sort((a,b) => new Date(b.added_at) - new Date(a.added_at));

                renderGrid(allData);
            } catch (e) {
                console.error(e);
                document.getElementById('grid').innerHTML = '<p class="text-red-500 text-center col-span-full">حدث خطأ في الاتصال</p>';
            }
        }

        // 2. عرض الشبكة
        function renderGrid(items) {
            const grid = document.getElementById('grid');
            const msg = document.getElementById('empty-msg');
            
            if (items.length === 0) {
                msg.classList.remove('hidden');
                grid.innerHTML = '';
                return;
            }
            
            msg.classList.add('hidden');
            grid.innerHTML = items.map(item => `
                <div onclick="openModal('${item.id}', '${item.type}')" class="group relative cursor-pointer rounded-lg overflow-hidden bg-gray-800 aspect-[2/3] hover:scale-105 transition duration-300">
                    <img src="${item.poster_path}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100" loading="lazy">
                    <div class="absolute top-2 right-2 bg-brand text-white text-[10px] font-bold px-2 py-1 rounded shadow">
                        ★ ${item.vote_average || '0.0'}
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition flex flex-col justify-end p-3">
                        <h3 class="font-bold text-sm text-white">${item.title}</h3>
                        <span class="text-xs text-brand font-bold">${item.type === 'movie' ? 'فيلم' : 'مسلسل'}</span>
                    </div>
                </div>
            `).join('');
        }

        function filterType(type) {
            const filtered = allData.filter(x => x.type === type);
            renderGrid(filtered);
        }

        // 3. فتح التفاصيل
        async function openModal(id, type) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            
            // البحث عن العنصر في الذاكرة (أسرع من النت)
            const item = allData.find(x => x.id === id);
            
            // تصميم المودال
            content.innerHTML = `
                <div class="relative h-[60vh]">
                    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${item.backdrop_path}')"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                    <div class="absolute bottom-0 w-full p-6 md:p-10">
                        <h1 class="text-3xl md:text-5xl font-black mb-4">${item.title}</h1>
                        <p class="text-gray-300 max-w-2xl text-lg mb-6 line-clamp-3">${item.overview || 'لا يوجد وصف'}</p>
                        <div id="action-area">
                            <button onclick="playMedia('${item.id}', '${type}')" class="bg-brand text-white px-8 py-3 rounded font-bold hover:bg-red-700 transition flex items-center gap-2">
                                <i class="fas fa-play"></i> ${type === 'movie' ? 'مشاهدة الفيلم' : 'عرض الحلقات'}
                            </button>
                        </div>
                    </div>
                </div>
                <div id="player-container" class="container mx-auto px-4 pb-20 mt-10 hidden"></div>
            `;
        }

        async function playMedia(id, type) {
            const container = document.getElementById('player-container');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-circle-notch fa-spin text-3xl"></i><p>جاري جلب السيرفر...</p></div>';
            
            // السكرول للمشغل
            container.scrollIntoView({behavior: 'smooth'});

            if (type === 'movie') {
                const { data } = await supabase.from('servers').select('*').eq('movie_id', id).limit(1).single();
                if (data) {
                    container.innerHTML = `<div class="bg-black aspect-video rounded-xl overflow-hidden shadow-2xl"><iframe src="${data.embed_url}" class="w-full h-full" frameborder="0" allowfullscreen></iframe></div>`;
                } else {
                    container.innerHTML = '<p class="text-center text-red-500">عذراً، السيرفر غير متاح حالياً.</p>';
                }
            } else {
                // لو مسلسل، هات المواسم
                const { data: seasons } = await supabase.from('seasons').select('*').eq('series_id', id).order('season_number', {ascending: true});
                if (seasons && seasons.length > 0) {
                    let seasonsHTML = seasons.map(s => `<button onclick="loadEpisodes('${s.id}')" class="bg-gray-800 px-4 py-2 rounded-full hover:bg-brand transition">${s.name}</button>`).join('');
                    container.innerHTML = `
                        <h3 class="text-xl font-bold mb-4">اختر الموسم:</h3>
                        <div class="flex gap-2 overflow-x-auto pb-4 mb-4">${seasonsHTML}</div>
                        <div id="episodes-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                    `;
                    // حمل حلقات أول موسم
                    loadEpisodes(seasons[0].id);
                } else {
                    container.innerHTML = '<p class="text-center text-gray-500">لا توجد مواسم متاحة.</p>';
                }
            }
        }

        async function loadEpisodes(seasonId) {
            const list = document.getElementById('episodes-list');
            list.innerHTML = '<p class="col-span-full text-center">جاري التحميل...</p>';
            
            const { data: eps } = await supabase.from('episodes').select('*').eq('season_id', seasonId).order('episode_number', {ascending: true});
            
            if (eps && eps.length > 0) {
                list.innerHTML = eps.map(ep => `
                    <div onclick="playEp('${ep.id}')" class="bg-gray-800 p-3 rounded hover:bg-gray-700 cursor-pointer flex gap-4 transition group">
                        <img src="${ep.still_path || 'https://via.placeholder.com/150'}" class="w-24 object-cover rounded">
                        <div>
                            <h4 class="font-bold text-sm group-hover:text-brand">حلقة ${ep.episode_number}</h4>
                            <span class="text-xs text-gray-500 line-clamp-1">${ep.name}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p class="col-span-full text-center">لا توجد حلقات.</p>';
            }
        }

        async function playEp(epId) {
            // تشغيل الحلقة في نافذة جديدة أو نفس المكان (للتبسيط هنا)
            const { data } = await supabase.from('servers').select('*').eq('episode_id', epId).limit(1).single();
            if (data) {
                window.open(data.embed_url, '_blank'); // فتح في تبويب جديد كحل سريع
            } else {
                alert('السيرفر غير متاح');
            }
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        // بدء التشغيل
        init();
    </script>
</body>
</html>
