<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C I N E M A • P R O</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#E50914', dark: '#141414' } } }
        }
    </script>
    <style>
        body { background-color: #141414; color: white; font-family: 'Segoe UI', sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        
        <header class="glass fixed w-full z-50 border-b border-gray-800">
            <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                <h1 class="text-3xl font-black text-primary tracking-tighter cursor-pointer" @click="view = 'home'">CINEMA<span class="text-white">PRO</span></h1>
                <div class="relative w-1/3 hidden md:block">
                    <input v-model="searchQuery" @input="searchMovies" type="text" placeholder="ابحث عن فيلم، ممثل، أو تصنيف..." class="w-full bg-black/50 border border-gray-700 rounded-full py-2 px-5 focus:border-primary focus:outline-none transition">
                </div>
            </div>
        </header>

        <main class="flex-grow pt-20 pb-10 px-4 container mx-auto">
            
            <div v-if="loading" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div v-for="n in 10" :key="n" class="animate-pulse bg-gray-800 h-80 rounded-xl"></div>
            </div>

            <div v-else-if="view === 'home'">
                <h2 class="text-2xl font-bold mb-6 border-r-4 border-primary pr-3">الأحدث والاقوى</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                    <div v-for="movie in movies" :key="movie.id" @click="openMovie(movie)" class="group cursor-pointer relative">
                        <div class="overflow-hidden rounded-xl aspect-[2/3]">
                            <img :src="'https://image.tmdb.org/t/p/w500' + movie.poster" class="object-cover w-full h-full group-hover:scale-110 transition duration-500">
                        </div>
                        <div class="absolute top-2 right-2 bg-black/70 backdrop-blur px-2 py-1 rounded text-xs font-bold text-yellow-400">
                            ★ {{ movie.rating.toFixed(1) }}
                        </div>
                        <h3 class="mt-2 font-bold truncate group-hover:text-primary transition">{{ movie.title }}</h3>
                        <p class="text-xs text-gray-400">{{ new Date(movie.created_at).getFullYear() }}</p>
                    </div>
                </div>
            </div>

            <div v-else-if="view === 'movie'" class="animate-fade-in">
                <div class="relative h-[70vh] w-full rounded-2xl overflow-hidden mb-10">
                    <div class="absolute inset-0 bg-gradient-to-t from-[#141414] via-transparent to-transparent z-10"></div>
                    <img :src="'https://image.tmdb.org/t/p/original' + selectedMovie.backdrop" class="w-full h-full object-cover opacity-60">
                    
                    <div class="absolute bottom-0 left-0 w-full p-10 z-20 flex flex-col md:flex-row items-end gap-8">
                        <img :src="'https://image.tmdb.org/t/p/w500' + selectedMovie.poster" class="w-48 rounded-lg shadow-2xl border-2 border-gray-700 hidden md:block">
                        <div class="flex-1">
                            <h1 class="text-5xl font-black mb-4">{{ selectedMovie.title }}</h1>
                            <div class="flex gap-3 mb-6">
                                <span v-for="genre in selectedMovie.genres" :key="genre" class="bg-gray-800 px-3 py-1 rounded-full text-xs text-gray-300">{{ genre }}</span>
                            </div>
                            <p class="text-gray-300 max-w-2xl text-lg leading-relaxed mb-6">{{ selectedMovie.overview }}</p>
                            
                            <div class="flex gap-4">
                                <button @click="playMovie" class="bg-primary hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold flex items-center gap-2 transition">
                                    ▶ مشاهدة الآن
                                </button>
                                <button class="bg-gray-800 hover:bg-gray-700 px-8 py-3 rounded-lg font-bold transition">
                                    + قائمتي
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="isPlaying" class="fixed inset-0 z-[100] bg-black flex items-center justify-center">
                    <button @click="isPlaying = false" class="absolute top-5 right-5 text-white text-2xl z-50">✕</button>
                    <iframe :src="currentServer" class="w-full h-full border-0" allowfullscreen></iframe>
                </div>

                <h3 class="text-2xl font-bold mb-4">طاقم التمثيل</h3>
                <div class="flex gap-4 overflow-x-auto pb-4 hide-scroll">
                    <div v-for="actor in selectedMovie.cast" :key="actor.name" class="min-w-[120px] text-center">
                        <img :src="actor.img ? 'https://image.tmdb.org/t/p/w200' + actor.img : 'https://placehold.co/200x300'" class="w-24 h-24 rounded-full object-cover mx-auto mb-2 border border-gray-700">
                        <p class="text-sm font-bold">{{ actor.name }}</p>
                        <p class="text-xs text-gray-500">{{ actor.role }}</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const _supabase = supabase.createClient('URL_HERE', 'KEY_HERE');

        createApp({
            setup() {
                const view = ref('home');
                const movies = ref([]);
                const loading = ref(true);
                const selectedMovie = ref(null);
                const isPlaying = ref(false);
                const currentServer = ref('');
                const searchQuery = ref('');

                // Fetch Movies using the Advanced Table
                const fetchMovies = async () => {
                    loading.value = true;
                    let query = _supabase.from('advanced_movies').select('*').order('created_at', { ascending: false }).limit(50);
                    
                    if (searchQuery.value) {
                        query = _supabase.from('advanced_movies').select('*').textSearch('search_vector', searchQuery.value);
                    }

                    const { data, error } = await query;
                    if (data) movies.value = data;
                    loading.value = false;
                };

                const openMovie = (movie) => {
                    selectedMovie.value = movie;
                    view.value = 'movie';
                    window.scrollTo(0, 0);
                };

                const searchMovies = _.debounce(() => {
                    fetchMovies();
                }, 500); // Debounce search to save API calls

                const playMovie = () => {
                    // Logic to select best server
                    if (selectedMovie.value.servers && selectedMovie.value.servers[0]) {
                        currentServer.value = selectedMovie.value.servers[0].url;
                        isPlaying.value = true;
                    } else {
                        alert('عذراً، السيرفر جاري تجهيزه بواسطة الذكاء الاصطناعي!');
                    }
                };

                onMounted(() => {
                    fetchMovies();
                });

                return { view, movies, loading, selectedMovie, openMovie, isPlaying, playMovie, currentServer, searchQuery, searchMovies };
            }
        }).mount('#app');
    </script>
</body>
</html>
